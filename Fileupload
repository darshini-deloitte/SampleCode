import { LightningElement } from 'lwc';
import getAccounts from '@salesforce/apex/YourApexClass.getAccounts'; // <-- Update this line

export default class AccountExcelDownload extends LightningElement {
    handleDownload() {
        getAccounts()
            .then(data => {
                if (data && data.length > 0) {
                    this.downloadCSV(data);
                } else {
                    console.warn('No account data returned');
                }
            })
            .catch(error => {
                console.error('Error fetching account data:', error);
            });
    }

    downloadCSV(data) {
        // Get dynamic keys from the first account
        const headers = Object.keys(data[0]);

        // Build CSV content
        let csvContent = headers.join(',') + '\n';

        data.forEach(record => {
            const row = headers.map(field => {
                const val = record[field];
                // Handle undefined/null and escape commas/quotes
                return `"${val !== undefined && val !== null ? String(val).replace(/"/g, '""') : ''}"`;
            });
            csvContent += row.join(',') + '\n';
        });

        // Create a Blob and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'Accounts.xlsx'; // .csv is technically correct, but Excel opens both
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
}
